<%- include('../partials/head', { title: 'Alerts' }); %>
<%- include('../partials/header'); %>
<%- include('../partials/sidebar'); %>

<!-- Main Content -->
<main class="md:ml-64 pt-16 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Page Header -->
        <div class="mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Alert Management</h1>
                    <p class="text-gray-600">Monitor and manage system alerts and notifications</p>
                </div>
                <div class="mt-4 md:mt-0 flex space-x-3">
                    <button id="newAlertBtn" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-plus mr-2"></i> New Alert
                    </button>
                    <button id="refreshAlerts" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Alert Statistics -->
        <% if (stats) { %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Alerts</p>
                        <p class="text-2xl font-bold text-gray-800"><%= stats.total %></p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-bell text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Critical</p>
                        <p class="text-2xl font-bold text-red-600"><%= stats.bySeverity.critical %></p>
                    </div>
                    <div class="p-3 bg-red-100 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Unresolved</p>
                        <p class="text-2xl font-bold text-yellow-600"><%= stats.total - stats.resolved %></p>
                    </div>
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Trend</p>
                        <p class="text-2xl font-bold <%= stats.recentTrend === 'increasing' ? 'text-red-600' : 
                                                         stats.recentTrend === 'decreasing' ? 'text-green-600' : 
                                                         'text-gray-800' %>">
                            <%= stats.recentTrend %>
                        </p>
                    </div>
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <i class="fas fa-chart-line text-gray-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
        
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Filters</h2>
            </div>
            <div class="p-4">
                <form id="filterForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active</option>
                            <option value="resolved" <%= filters.status === 'resolved' ? 'selected' : '' %>>Resolved</option>
                            <option value="acknowledged" <%= filters.status === 'acknowledged' ? 'selected' : '' %>>Acknowledged</option>
                            <option value="unacknowledged" <%= filters.status === 'unacknowledged' ? 'selected' : '' %>>Unacknowledged</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
                        <select name="severity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All</option>
                            <% Object.values(severityLevels).forEach(function(level) { %>
                                <option value="<%= level %>" <%= filters.severity === level ? 'selected' : '' %>>
                                    <%= level.charAt(0).toUpperCase() + level.slice(1) %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select name="type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All</option>
                            <% Object.values(alertTypes).forEach(function(type) { %>
                                <option value="<%= type %>" <%= filters.type === type ? 'selected' : '' %>>
                                    <%= type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                            Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Alerts Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-800">
                    Alerts 
                    <% if (pagination) { %>
                        <span class="text-sm font-normal text-gray-600">(<%= pagination.totalItems %> total)</span>
                    <% } %>
                </h2>
                <div class="flex space-x-2">
                    <button id="bulkAcknowledgeBtn" class="px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" disabled>
                        <i class="fas fa-check mr-1"></i> Acknowledge Selected
                    </button>
                    <button id="bulkResolveBtn" class="px-3 py-1 bg-green-100 text-green-700 text-sm rounded hover:bg-green-200" disabled>
                        <i class="fas fa-check-double mr-1"></i> Resolve Selected
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAll" class="rounded border-gray-300">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Alert
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Severity
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Time
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <% if (alerts && alerts.length > 0) { %>
                            <% alerts.forEach(function(alert) { %>
                                <tr class="hover:bg-gray-50" id="alert-<%= alert._id %>">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" class="alert-checkbox rounded border-gray-300" value="<%= alert._id %>">
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0">
                                                <div class="p-2 rounded-lg <%= alert.severity === 'critical' ? 'bg-red-100' : 
                                                                          alert.severity === 'high' ? 'bg-orange-100' : 
                                                                          alert.severity === 'medium' ? 'bg-yellow-100' : 
                                                                          'bg-blue-100' %>">
                                                    <i class="fas fa-bell <%= alert.severity === 'critical' ? 'text-red-600' : 
                                                                          alert.severity === 'high' ? 'text-orange-600' : 
                                                                          alert.severity === 'medium' ? 'text-yellow-600' : 
                                                                          'text-blue-600' %>"></i>
                                                </div>
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">
                                                    <%= alert.title %>
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    <%= alert.message.length > 100 ? alert.message.substring(0, 100) + '...' : alert.message %>
                                                </div>
                                                <div class="text-xs text-gray-400 mt-1">
                                                    Device: <%= alert.deviceId || 'N/A' %>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                            <%= alert.severity === 'critical' ? 'bg-red-100 text-red-800' : 
                                               alert.severity === 'high' ? 'bg-orange-100 text-orange-800' : 
                                               alert.severity === 'medium' ? 'bg-yellow-100 text-yellow-800' : 
                                               'bg-blue-100 text-blue-800' %>">
                                            <%= alert.severity %>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex flex-col space-y-1">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                <%= alert.resolved ? 'bg-green-100 text-green-800' : 
                                                   alert.acknowledged ? 'bg-blue-100 text-blue-800' : 
                                                   'bg-yellow-100 text-yellow-800' %>">
                                                <%= alert.resolved ? 'Resolved' : 
                                                    alert.acknowledged ? 'Acknowledged' : 'Active' %>
                                            </span>
                                            <% if (alert.acknowledgedBy) { %>
                                                <span class="text-xs text-gray-500">
                                                    By: <%= alert.acknowledgedBy.name %>
                                                </span>
                                            <% } %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div><%= helpers.formatDate(alert.createdAt, true) %></div>
                                        <div class="text-xs text-gray-400"><%= helpers.timeAgo(alert.createdAt) %></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <% if (!alert.acknowledged) { %>
                                                <button onclick="acknowledgeAlert('<%= alert._id %>')" 
                                                        class="text-blue-600 hover:text-blue-900">
                                                    Acknowledge
                                                </button>
                                            <% } %>
                                            <% if (!alert.resolved) { %>
                                                <button onclick="resolveAlert('<%= alert._id %>')" 
                                                        class="text-green-600 hover:text-green-900">
                                                    Resolve
                                                </button>
                                            <% } %>
                                            <% if (isAdmin) { %>
                                                <button onclick="deleteAlert('<%= alert._id %>')" 
                                                        class="text-red-600 hover:text-red-900">
                                                    Delete
                                                </button>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                                    <h3 class="text-lg font-medium text-gray-900">No alerts found</h3>
                                    <p class="text-gray-500 mt-1">All systems are operating normally</p>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <% if (pagination && pagination.totalPages > 1) { %>
            <div class="px-6 py-4 border-t bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-medium"><%= (pagination.currentPage - 1) * 20 + 1 %></span>
                        to <span class="font-medium"><%= Math.min(pagination.currentPage * 20, pagination.totalItems) %></span>
                        of <span class="font-medium"><%= pagination.totalItems %></span> results
                    </div>
                    <div class="flex space-x-2">
                        <% if (pagination.hasPrev) { %>
                            <a href="?page=<%= pagination.prevPage %><%= filters.status ? '&status=' + filters.status : '' %><%= filters.severity ? '&severity=' + filters.severity : '' %><%= filters.type ? '&type=' + filters.type : '' %>" 
                               class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Previous
                            </a>
                        <% } %>
                        
                        <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                            <% if (i === pagination.currentPage) { %>
                                <span class="px-3 py-2 border border-blue-500 bg-blue-50 text-blue-600 rounded-md text-sm font-medium">
                                    <%= i %>
                                </span>
                            <% } else if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) { %>
                                <a href="?page=<%= i %><%= filters.status ? '&status=' + filters.status : '' %><%= filters.severity ? '&severity=' + filters.severity : '' %><%= filters.type ? '&type=' + filters.type : '' %>" 
                                   class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    <%= i %>
                                </a>
                            <% } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) { %>
                                <span class="px-3 py-2 text-gray-500">...</span>
                            <% } %>
                        <% } %>
                        
                        <% if (pagination.hasNext) { %>
                            <a href="?page=<%= pagination.nextPage %><%= filters.status ? '&status=' + filters.status : '' %><%= filters.severity ? '&severity=' + filters.severity : '' %><%= filters.type ? '&type=' + filters.type : '' %>" 
                               class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Next
                            </a>
                        <% } %>
                    </div>
                </div>
            </div>
            <% } %>
        </div>
    </div>
</main>

<!-- New Alert Modal -->
<div id="newAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Create New Alert</h3>
        </div>
        <form id="newAlertForm" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Alert Type</label>
                <select name="type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Type</option>
                    <% Object.values(alertTypes).forEach(function(type) { %>
                        <option value="<%= type %>">
                            <%= type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                        </option>
                    <% }); %>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
                <select name="severity" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Severity</option>
                    <% Object.values(severityLevels).forEach(function(level) { %>
                        <option value="<%= level %>">
                            <%= level.charAt(0).toUpperCase() + level.slice(1) %>
                        </option>
                    <% }); %>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                <input type="text" name="title" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter alert title">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                <textarea name="message" required rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="Describe the alert..."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Device ID (Optional)</label>
                <input type="text" name="deviceId" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="ESP32_SOLAR_01">
            </div>
        </form>
        <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3">
            <button type="button" id="cancelNewAlert" class="px-4 py-2 text-gray-700 hover:text-gray-900">
                Cancel
            </button>
            <button type="submit" form="newAlertForm" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Create Alert
            </button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let selectedAlerts = new Set();
    
    // Initialize alerts page
    $(document).ready(function() {
        setupEventListeners();
        updateBulkButtons();
    });
    
    // Set up event listeners
    function setupEventListeners() {
        // Filter form submission
        $('#filterForm').submit(function(e) {
            e.preventDefault();
            const formData = $(this).serialize();
            window.location.href = '?' + formData;
        });
        
        // Select all checkbox
        $('#selectAll').change(function() {
            const isChecked = $(this).prop('checked');
            $('.alert-checkbox').prop('checked', isChecked);
            
            if (isChecked) {
                $('.alert-checkbox').each(function() {
                    selectedAlerts.add($(this).val());
                });
            } else {
                selectedAlerts.clear();
            }
            
            updateBulkButtons();
        });
        
        // Individual alert checkboxes
        $(document).on('change', '.alert-checkbox', function() {
            const alertId = $(this).val();
            
            if ($(this).prop('checked')) {
                selectedAlerts.add(alertId);
            } else {
                selectedAlerts.delete(alertId);
                $('#selectAll').prop('checked', false);
            }
            
            updateBulkButtons();
        });
        
        // Bulk acknowledge button
        $('#bulkAcknowledgeBtn').click(function() {
            if (selectedAlerts.size > 0) {
                bulkAction('acknowledge');
            }
        });
        
        // Bulk resolve button
        $('#bulkResolveBtn').click(function() {
            if (selectedAlerts.size > 0) {
                bulkAction('resolve');
            }
        });
        
        // New alert button
        $('#newAlertBtn').click(function() {
            $('#newAlertModal').removeClass('hidden');
        });
        
        // Cancel new alert
        $('#cancelNewAlert').click(function() {
            $('#newAlertModal').addClass('hidden');
            $('#newAlertForm')[0].reset();
        });
        
        // New alert form submission
        $('#newAlertForm').submit(function(e) {
            e.preventDefault();
            createNewAlert($(this).serializeArray());
        });
        
        // Refresh button
        $('#refreshAlerts').click(function() {
            window.location.reload();
        });
    }
    
    // Update bulk action buttons state
    function updateBulkButtons() {
        const hasSelected = selectedAlerts.size > 0;
        $('#bulkAcknowledgeBtn').prop('disabled', !hasSelected);
        $('#bulkResolveBtn').prop('disabled', !hasSelected);
    }
    
    // Bulk action (acknowledge/resolve)
    function bulkAction(action) {
        const alertIds = Array.from(selectedAlerts);
        const actionText = action === 'acknowledge' ? 'acknowledge' : 'resolve';
        
        if (confirm(`Are you sure you want to ${actionText} ${alertIds.length} selected alert(s)?`)) {
            const url = action === 'acknowledge' 
                ? '/alerts/api/alerts/bulk-acknowledge' 
                : '/alerts/api/alerts/bulk-resolve';
            
            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ids: alertIds }),
                success: function(response) {
                    toastr.success(`Successfully ${actionText}d ${response.modifiedCount} alert(s)`);
                    
                    // Remove selected alerts from table
                    alertIds.forEach(id => {
                        $(`#alert-${id}`).remove();
                    });
                    
                    // Clear selection
                    selectedAlerts.clear();
                    $('.alert-checkbox').prop('checked', false);
                    $('#selectAll').prop('checked', false);
                    updateBulkButtons();
                    
                    // Update statistics
                    updateAlertStatistics();
                },
                error: function() {
                    toastr.error(`Failed to ${actionText} alerts`);
                }
            });
        }
    }
    
    // Acknowledge single alert
    window.acknowledgeAlert = function(alertId) {
        if (confirm('Mark this alert as acknowledged?')) {
            $.ajax({
                url: `/alerts/api/alerts/${alertId}/acknowledge`,
                method: 'PUT',
                success: function() {
                    toastr.success('Alert acknowledged');
                    // Update row appearance
                    const row = $(`#alert-${alertId}`);
                    row.find('.alert-checkbox').prop('checked', false);
                    row.remove();
                    updateAlertStatistics();
                },
                error: function() {
                    toastr.error('Failed to acknowledge alert');
                }
            });
        }
    };
    
    // Resolve single alert
    window.resolveAlert = function(alertId) {
        if (confirm('Mark this alert as resolved?')) {
            $.ajax({
                url: `/alerts/api/alerts/${alertId}/resolve`,
                method: 'PUT',
                success: function() {
                    toastr.success('Alert resolved');
                    // Update row appearance
                    const row = $(`#alert-${alertId}`);
                    row.find('.alert-checkbox').prop('checked', false);
                    row.remove();
                    updateAlertStatistics();
                },
                error: function() {
                    toastr.error('Failed to resolve alert');
                }
            });
        }
    };
    
    // Delete single alert (admin only)
    window.deleteAlert = function(alertId) {
        if (confirm('Are you sure you want to delete this alert? This action cannot be undone.')) {
            $.ajax({
                url: `/alerts/api/alerts/${alertId}`,
                method: 'DELETE',
                success: function() {
                    toastr.success('Alert deleted');
                    $(`#alert-${alertId}`).remove();
                    updateAlertStatistics();
                },
                error: function() {
                    toastr.error('Failed to delete alert');
                }
            });
        }
    };
    
    // Create new alert
    function createNewAlert(formData) {
        const data = {};
        formData.forEach(item => {
            data[item.name] = item.value;
        });
        
        $.ajax({
            url: '/alerts/api/alerts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                toastr.success('Alert created successfully');
                $('#newAlertModal').addClass('hidden');
                $('#newAlertForm')[0].reset();
                
                // Reload page to show new alert
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.message : 'Failed to create alert';
                toastr.error(error);
            }
        });
    }
    
    // Update alert statistics
    function updateAlertStatistics() {
        // In a real implementation, you would fetch updated stats from the server
        // For now, we'll just reload the page
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
</script>

<%- include('../partials/footer'); %>
<%- include('../partials/scripts'); %>